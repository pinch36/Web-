<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>登录</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

    <style>
        * {
            font-family: "Poppins";
        }

        body {
            user-select: none;
            overflow-y: hidden;
            display: flex;
            justify-content: center;
            /*align-items: center;*/
            background: #dde5f4;
            height: 100vh;
        }

        .screen-1 {
            width: 500px;
            height: 800px;
            background: #f1f7fe;
            padding: 2em;
            display: flex;
            flex-direction: column;
            border-radius: 30px;
            box-shadow: 0 0 2em #e6e9f9;
            gap: 1em;
        }

        .screen-1 .logo {
            margin-top: -3em;
            margin-left: 5em;
        }

        .screen-1 .account {
            background: white;
            box-shadow: 0 0 2em #e6e9f9;
            padding: 1em;
            display: flex;
            flex-direction: column;
            gap: 0.5em;
            border-radius: 20px;
            color: #4d4d4d;
            margin-top: -3em;
        }

        .screen-1 .account input {
            outline: none;
            border: none;
        }

        .screen-1 .account input::placeholder {
            color: black;
            font-size: 0.9em;
        }

        .screen-1 .account ion-icon {
            color: #4d4d4d;
            margin-bottom: -0.2em;
        }

        .screen-1 .password {
            background: white;
            box-shadow: 0 0 2em #e6e9f9;
            padding: 1em;
            display: flex;
            flex-direction: column;
            gap: 0.5em;
            border-radius: 20px;
            color: #4d4d4d;
            /*margin: 0;*/
        }

        .screen-1 .password input {
            outline: none;
            border: none;
            width: 400px;
        }

        .screen-1 .password input::placeholder {
            color: black;
            font-size: 0.9em;
        }

        .screen-1 .password ion-icon {
            color: #4d4d4d;
            margin-bottom: -0.2em;
        }

        .screen-1 .password .show-hide {
            margin-right: -5em;
            cursor: pointer;
        }

        .screen-1 .login {
            padding: 1em;
            background: #3e4684;
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: 600;
        }

        .screen-1 .reset {
            padding: 1em;
            background: #A6B1E1;
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: 600;
        }

        .screen-1 .footer {
            display: flex;
            justify-content: space-around;
            font-size: 0.7em;
            color: #5e5e5e;
            gap: 14em;
            padding-bottom: 10em;
        }

        .screen-1 .footer span {
            cursor: pointer;
        }

        button {
            cursor: pointer;
        }

        .result {
            text-align: right;
            font-size: xx-small;
            float: right;
            clear: right;
            color: red;
        }

        .remember {
            display: flex;
            justify-content: flex-end; /* 靠右 */
            align-items: center;
        }

        .remember input {
            margin-right: 0.5em;
        }

        /* 美化 .remember 容器 */
        .remember {
            display: flex;
            align-items: center;
            justify-content: flex-end; /* 将复选框和标签靠右对齐 */
            margin-bottom: 1em;
        }

        /* 隐藏默认复选框 */
        .remember input[type="checkbox"] {
            display: none;
        }

        /* 创建自定义复选框 */
        .remember label {
            position: relative;
            padding-left: 25px;
            cursor: pointer;
            user-select: none;
        }

        /* 自定义复选框的外观 */
        .remember label::before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border: 2px solid #3e4684; /* 边框颜色 */
            border-radius: 4px; /* 圆角 */
            background: white;
        }

        /* 选中复选框后的外观 */
        .remember input[type="checkbox"]:checked + label::before {
            background-color: #3e4684; /* 选中后的背景颜色 */
            border-color: #3e4684;
        }

        /* 添加复选框选中时的对勾 */
        .remember input[type="checkbox"]:checked + label::after {
            content: "";
            position: absolute;
            left: 8px;
            top: 45%;
            transform: translateY(-50%) rotate(45deg);
            width: 5px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
        }

        /* 标签文本样式 */
        .remember label {
            color: #4d4d4d;
            font-size: 0.9em;
        }


    </style>
</head>
<body>
<div class="screen-1">
    <svg class="logo" xmlns="http://www.w3.org/2000/svg" version="1.1" width="300" height="250"
         viewbox="0 0 640 480" xml:space="preserve">
    <g transform="matrix(3.31 0 0 3.31 320.4 240.4)">
      <circle style="stroke: rgb(0,0,0); stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(61,71,133); fill-rule: nonzero; opacity: 1;"
              cx="0" cy="0" r="40"></circle>
    </g>
        <g transform="matrix(0.98 0 0 0.98 268.7 213.7)">
      <circle style="stroke: rgb(0,0,0); stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;"
              cx="0" cy="0" r="40"></circle>
    </g>
        <g transform="matrix(1.01 0 0 1.01 362.9 210.9)">
      <circle style="stroke: rgb(0,0,0); stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;"
              cx="0" cy="0" r="40"></circle>
    </g>
        <g transform="matrix(0.92 0 0 0.92 318.5 286.5)">
      <circle style="stroke: rgb(0,0,0); stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;"
              cx="0" cy="0" r="40"></circle>
    </g>
        <g transform="matrix(0.16 -0.12 0.49 0.66 290.57 243.57)">
      <polygon
              style="stroke: rgb(0,0,0); stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;"
              points="-50,-50 -50,50 50,50 50,-50 "></polygon>
    </g>
        <g transform="matrix(0.16 0.1 -0.44 0.69 342.03 248.34)">
      <polygon
              style="stroke: rgb(0,0,0); stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;"
              vector-effect="non-scaling-stroke" points="-50,-50 -50,50 50,50 50,-50 "></polygon>
    </g>
  </svg>
    <div class="account">
        <label for="account" style="font-weight: bold;">账 号</label>
        <div class="sec-2">
            <ion-icon name="person-outline"></ion-icon>
            <input id="account" type="account" name="account" placeholder="请输入账号"/>

        </div>
        <!-- 提示信息 -->
        <span class="result" id="account-error"></span>
    </div>
    <div class="password">
        <label for="password" style="font-weight: bold;">密 码</label>
        <div class="sec-2">
            <ion-icon name="lock-closed-outline"></ion-icon>
            <input id="password" class="pas" type="password" name="password" placeholder="请输入密码"/>
            <ion-icon class="show-hide" name="eye-outline"></ion-icon>
        </div>
        <!-- 提示信息 -->
        <span class="result" id="password-error"></span>
    </div>
    <div class="remember">
        <input type="checkbox" id="remember" name="remember">
        <label for="remember">记住密码</label>
    </div>
    <button class="login" id="login">登录</button>
    <button class="reset" id="reset">重置</button>
    <div class="footer">
        <span onclick="window.location.href='register.html'">注册</span>
        <span id="forget-password">忘记密码</span>
    </div>
</div>

<script>
    // 获取输入框和按钮
    const accountInput = document.getElementById("account");
    const passwordInput = document.getElementById("password");
    const loginButton = document.getElementById("login");

    // 添加事件监听器，实时验证输入
    accountInput.addEventListener("input", validateAccount);
    accountInput.addEventListener("blur", validateAccount);
    passwordInput.addEventListener("input", validatePassword);
    passwordInput.addEventListener("blur", validatePassword);

    let flag1, flag2;

    // 判断表单合法性
    function validateAccount() {
        const accountError = document.getElementById("account-error");
        const accountValue = accountInput.value.trim(); // 获取输入框的值，并去除首尾空格

        accountError.innerText = ""; // 先清空错误提示
        // loginButton.disabled = true; // 先禁用提交按钮
        loginButton.classList.add("disabled");
        flag1 = true;

        if (accountValue.trim() === "") {
            accountError.innerText = "账号不能为空";
            flag1 = false;
            return false;
        }

        if (accountValue.length !== 10) {
            flag1 = false;
            if (accountError.innerText !== "")
                accountError.innerText += "，";
            accountError.innerText += "账号长度应为10位数字";
        }

        if (!/^[0-9]*$/.test(accountValue)) {
            flag1 = false;
            if (accountError.innerText !== "")
                accountError.innerText += "，";
            accountError.innerText += "账号仅能包含数字";
        }

        /*if (flag1 && flag2) {
            // 在恢复时将 disabled 属性设置为 false
            loginButton.disabled = false;

            // 移除 disabled 类名
            loginButton.classList.remove("disabled");
        }*/
        return true;
    }

    // 判断表单合法性
    function validatePassword() {
        const passwordError = document.getElementById("password-error");
        const passwordValue = passwordInput.value.trim(); // 获取输入框的值，并去除首尾空格

        passwordError.innerText = ""; // 先清空错误提示
        // loginButton.disabled = true; // 先禁用提交按钮
        loginButton.classList.add("disabled");
        flag2 = true;

        if (passwordValue.trim() === "") {
            flag2 = false;
            passwordError.innerText = "密码不能为空";
            return false;
        }
        let num = 0;
        if (/(?=.*\d)/.test(passwordValue))
            num++;
        if (/(?=.*[a-z])/.test(passwordValue) || /(?=.*[A-Z])/.test(passwordValue))
            num++;
        if (/(?=.*[!@#$%^&*.])/.test(passwordValue))
            num++;

        //用^和$包起来才是整个字符串完全匹配
        if (!/^[a-zA-Z\d!@#$%^&*.]{8,20}$/.test(passwordValue) && num < 2) {
            flag2 = false;
            passwordError.innerText = "密码长度应为8-20个字符，且密码需同时包含字母、数字或特殊字符两种及以上";
            return false;
        }

        if (!/^[a-zA-Z\d!@#$%^&*.]{8,20}$/.test(passwordValue)) {
            flag2 = false;
            passwordError.innerText += "密码长度应为8-20个字符";
        }

        // 检查密码是否包含字母、数字或特殊字符中的两种及以上
        if (num < 2) {
            flag2 = false;
            if (passwordError.innerText !== "")
                passwordError.innerText += "，";
            passwordError.innerText += "密码需同时包含字母、数字或特殊字符两种及以上";
        }

        /*if (flag1 && flag2) {
            // 在恢复时将 disabled 属性设置为 false
            loginButton.disabled = false;

            // 移除 disabled 类名
            loginButton.classList.remove("disabled");
        }*/
        return true;
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        let expirationTime = localStorage.getItem('expirationTime');
        let currentTime = new Date().getTime();

        if (localStorage.getItem('remember') === 'true' && expirationTime > currentTime) {
            document.getElementById('account').value = localStorage.getItem('account');
            document.getElementById('password').value = localStorage.getItem('password');
            document.getElementById('remember').checked = true;
        }
    });
    // 添加点击事件监听器
    document.getElementById("login").addEventListener("click", handleSubmit);
    document.getElementById("reset").addEventListener("click", handleReset);

    // 重置表单
    function handleReset() {
        Swal.fire({
            title: '确认重置表单吗？',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '确认',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                // 清空学号和密码输入框内容
                document.getElementById('account').value = '';
                document.getElementById('password').value = '';

                document.getElementById("account-error").innerText = '';
                document.getElementById("password-error").innerText = '';
                Swal.fire(
                    '已重置!',
                    '表单内容已被清空。',
                    'success'
                );
            }
        });
    }

    function hashPassword(password) {
        return CryptoJS.SHA256(password).toString();
    }

    /*// 生成随机的盐值
    function generateSalt(length) {
        const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let salt = '';
        for (let i = 0; i < length; i++) {
            salt += charset.charAt(Math.floor(Math.random() * charset.length));
        }
        return salt;
    }

    // 添加随机盐值进行加盐哈希
    function saltedHash(password, salt) {
        const saltedPassword = password + salt;
        return CryptoJS.SHA256(saltedPassword).toString();
    }*/

    //提交表单
    function handleSubmit() {
        if (!checkIncorrect()) {
            return;
        }

        validateAccount();
        validatePassword();
        if (!flag1 || !flag2) {
            return;
        }

        let account = document.getElementById('account').value;
        let password = document.getElementById('password').value;
        let remember = document.getElementById('remember').checked;
        // let expirationTime = new Date().getTime() + 7 * 24 * 60 * 60 * 1000; // 设置有效期为7天
        let expirationTime = new Date().getTime() + 10 * 1000; // 设置有效期为10s
        // 保存到localStorage
        if (remember) {
            localStorage.setItem('account', account);
            localStorage.setItem('password', password);
            localStorage.setItem('remember', true);
            localStorage.setItem('expirationTime', expirationTime);
        } else {
            localStorage.removeItem('account');
            localStorage.removeItem('password');
            localStorage.setItem('remember', false);
            localStorage.removeItem('expirationTime');
        }

        // const salt = generateSalt(16); // 生成长度为16的随机盐值
        // const hashedPassword = saltedHash(password, salt);
        // const hashedPassword = hashPassword(password);
        // console.log("原始密码:", password);
        // console.log("盐值:", salt);
        // console.log("加盐哈希后的密码:", hashedPassword);
        const hashedPassword = hashPassword(password);
        console.log("原始密码:", password);
        console.log("哈希后的密码:", hashedPassword);
        // const decryptedPassword = CryptoJS.AES.decrypt(encryptedPassword, 'secretKey').toString(CryptoJS.enc.Utf8);
        loginPost({account: account, hashed_password: hashedPassword}).then(receiveSuccess).catch(receiveError);
    }

    // POST请求
    function loginPost(params) {
        console.log("post传输账号", params.account);
        console.log("post传输密码", params.hashed_password);

        return new Promise((resolve, reject) => {
            /*// 模拟网络请求
            setTimeout(() => {
                // 随机返回成功或失败的结果
                if (Math.random() > 0.5) {
                    resolve({status: "success", message: "登录成功", code: 200});
                } else {
                    reject({status: "error", message: "账号或密码错误，登录失败", code: 500});
                }
            }, 500);*/
            fetch('http://localhost:8090/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(params)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 1) {
                        if (data.data.status === 0) {
                            reject({
                                status: "error",
                                message: "账号被禁用，请联系老师！",
                                code: data.code
                            });
                        } else {
                            localStorage.setItem('userData', JSON.stringify(data.data));
                            resolve({
                                status: "success",
                                message: data.msg,
                                code: data.code,
                                data: data.data
                            });
                        }
                    } else {
                        // 输入错误时进行记录
                        postIncorrect();

                        reject({
                            status: "error",
                            message: "账号或密码错误！",
                            code: data.code
                        });
                    }
                })
                .catch(error => {
                    reject({
                        status: "error",
                        message: "请求失败，服务器错误",
                        code: 500,
                        error: error
                    });
                });
        });
    }

    function receiveSuccess(response) {
        console.log(response);
        if (Swal) {
            Swal.fire({
                title: response.message,
                // text: response.message,
                icon: response.status,
                confirmButtonText: '确定'
            }).then((result) => {
                if (result.isConfirmed) {
                    // 在点击确定后执行页面跳转
                    //todo 跳转页面
                    window.location.href = './personInfo.html';
                }
            });
        }
    }

    function receiveError(response) {
        if (Swal) {
            Swal.fire({
                title: response.message,
                // text: response.status,
                icon: response.status,
                confirmButtonText: '确定'
            })
        }
    }

    window.receiveSuccess = receiveSuccess;
    window.receiveError = receiveError;
</script>
<script>
    // 切换密码显示隐藏
    const showHide = document.querySelector('.show-hide');
    const passwordField = document.querySelector('.pas');

    showHide.addEventListener('click', function () {
        if (passwordField.type === "password") {
            passwordField.type = "text";
            showHide.name = "eye-off-outline";
        } else {
            passwordField.type = "password";
            showHide.name = "eye-outline";
        }
    });
</script>
<script>
    document.getElementById("forget-password").addEventListener("click", handleForgetPassword);

    function handleForgetPassword() {
        Swal.fire({
            title: '忘记密码',
            html:

                '<div class="sec-2">' +
                '    <label style="font-weight: bold;">账 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;号：</label>' +
                '    <input id="swal-account" class="swal-account" placeholder="请输入账号">' +
                '</div>' +
                '<div class="sec-2">' +
                '    <label style="font-weight: bold;">姓 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名：</label>' +
                '    <input id="swal-name" class="swal-name" placeholder="请输入姓名">' +
                '</div>' +
                '<div class="sec-2">' +
                '    <label style="font-weight: bold;">身份证号：</label>' +
                '    <input id="swal-id" class="swal-id" placeholder="请输入身份证号">' +
                '</div>',
            focusConfirm: false,
            confirmButtonText: '提交',
            preConfirm: () => {
                const account = document.getElementById('swal-account').value;
                const name = document.getElementById('swal-name').value;
                const id = document.getElementById('swal-id').value;

                if (!account || !name || !id) {
                    Swal.showValidationMessage('所有字段都是必填的');
                    return;
                }

                return {account, name, id};
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // 构造要发送的数据
                console.log(result)
                const forgetData = {
                    account: result.value.account,
                    username: result.value.name,
                    identity: result.value.id
                };

                fetch('http://localhost:8090/forget', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(forgetData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 1) {
                            Swal.fire({
                                title: '重置密码成功',
                                text: data.msg,
                                icon: 'success',
                                confirmButtonText: '确定'
                            });
                        } else {
                            Swal.fire({
                                title: '信息错误',
                                text: data.msg,
                                icon: 'error',
                                confirmButtonText: '确定'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            title: '请求失败',
                            text: '服务器错误',
                            icon: 'error'
                        });
                    });
            }
        });
    }
</script>
<script>
    function getCurrentTimeString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0'); // 月份从0开始，所以要加1，并确保是两位数
        const day = String(now.getDate()).padStart(2, '0'); // 确保是两位数
        const hour = String(now.getHours()).padStart(2, '0'); // 确保是两位数

        return `${year}_${month}_${day}_${hour}`;
    }

    // console.log("getCurrentTimeString:", getCurrentTimeString());

    function postIncorrect() {
        let time = getCurrentTimeString();
        let incorrectNum = localStorage.getItem(time);
        incorrectNum++;
        console.log("当前小时：", getCurrentTimeString(), " 错误次数：", incorrectNum);
        localStorage.setItem(time, incorrectNum);
    }

    let wait = false;

    function checkIncorrect() {
        if (wait) {
            Swal.fire({
                title: '错误次数过多',
                text: '请等待10s后再试',
                icon: 'error',
                confirmButtonText: '确定'
            });
            return false;
        }
        let time = getCurrentTimeString();
        let incorrectNum = localStorage.getItem(time);
        if (incorrectNum === null) {
            incorrectNum = 0;
        }
        localStorage.setItem(time, incorrectNum);
        if (incorrectNum >= 3) {
            wait = true;
            Swal.fire({
                title: '错误次数过多',
                text: '请等待10s后再试',
                icon: 'error',
                confirmButtonText: '确定'
            });
            setTimeout(function () {
                wait = false;
                localStorage.removeItem(time);
            }, 1000 * 10);
            return false;
        }
        return true;
    }

</script>
</body>
</html>
